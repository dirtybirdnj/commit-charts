<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Commit & PR Sentiment Explorer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #58a6ff; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        h2 { color: #8b949e; margin-top: 30px; margin-bottom: 10px; }

        .controls {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .project-btn {
            padding: 6px 12px;
            border: 2px solid;
            border-radius: 4px;
            background: transparent;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .project-btn:hover {
            transform: translateY(-1px);
        }
        .project-btn.active {
            color: #0d1117;
        }
        .project-btn.inactive {
            opacity: 0.3;
        }

        .type-filters {
            display: flex;
            gap: 6px;
        }
        .type-btn {
            padding: 5px 10px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background: #21262d;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        .type-btn.active {
            background: #388bfd;
            border-color: #388bfd;
        }
        .type-btn:hover {
            border-color: #8b949e;
        }

        .chart-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .stats-bar {
            display: flex;
            gap: 30px;
            padding: 10px 0;
            border-bottom: 1px solid #30363d;
            margin-bottom: 15px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #f0f6fc;
        }
        .stat-value.positive { color: #22c55e; }
        .stat-value.negative { color: #ef4444; }
        .stat-label {
            font-size: 11px;
            color: #8b949e;
            text-transform: uppercase;
        }

        .tooltip {
            position: absolute;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 400px;
            z-index: 1000;
        }
        .tooltip .type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 6px;
        }
        .tooltip .type-badge.commit { background: #388bfd; }
        .tooltip .type-badge.pr { background: #a855f7; }
        .tooltip .msg {
            margin-top: 6px;
            color: #8b949e;
            font-style: italic;
        }
        .tooltip .score {
            margin-top: 4px;
        }
        .tooltip .score.positive { color: #22c55e; }
        .tooltip .score.negative { color: #ef4444; }

        .axis text { fill: #8b949e; font-size: 11px; }
        .axis line, .axis path { stroke: #30363d; }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #30363d;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        .legend-shape {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hover-preview {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .hover-preview.empty {
            color: #484f58;
            text-align: center;
            font-style: italic;
        }
        .hover-preview .preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .hover-preview .preview-type {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .hover-preview .preview-type.commit { background: #388bfd; color: #fff; }
        .hover-preview .preview-type.pr { background: #a855f7; color: #fff; }
        .hover-preview .preview-project {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            color: #0d1117;
        }
        .hover-preview .preview-date {
            color: #8b949e;
            font-size: 11px;
            margin-left: auto;
        }
        .hover-preview .preview-msg {
            color: #c9d1d9;
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .hover-preview .preview-sentiment {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        .hover-preview .preview-score {
            font-weight: 600;
            font-size: 12px;
        }
        .hover-preview .preview-score.positive { color: #22c55e; }
        .hover-preview .preview-score.negative { color: #ef4444; }
        .hover-preview .preview-score.neutral { color: #8b949e; }
        .hover-preview .preview-hint {
            color: #484f58;
            font-size: 11px;
            margin-left: auto;
        }

        .detail-panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }
        .detail-panel h3 {
            margin: 0 0 15px 0;
            color: #58a6ff;
            font-size: 16px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }
        .detail-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .detail-item {
            padding: 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            background: #21262d;
            transition: all 0.2s;
            cursor: pointer;
        }
        .detail-item:hover {
            border-color: #58a6ff;
        }
        .detail-item.highlighted {
            border-color: #f0f6fc;
            background: #2d333b;
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
        }
        .detail-item .item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .detail-item .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .detail-item .type-badge.commit { background: #388bfd; color: #fff; }
        .detail-item .type-badge.pr { background: #a855f7; color: #fff; }
        .detail-item .project-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            color: #0d1117;
        }
        .detail-item .date {
            color: #8b949e;
            font-size: 11px;
            margin-left: auto;
        }
        .detail-item .msg {
            color: #c9d1d9;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .detail-item .sentiment-info {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .detail-item .sentiment-score {
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 3px;
        }
        .detail-item .sentiment-score.positive { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .detail-item .sentiment-score.negative { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .detail-item .sentiment-score.neutral { background: rgba(139, 148, 158, 0.2); color: #8b949e; }
        .detail-item .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .detail-item .keyword {
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-family: monospace;
        }
        .detail-item .keyword.positive { background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
        .detail-item .keyword.negative { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .project-section {
            margin-bottom: 20px;
        }
        .project-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #0d1117;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .project-section-header:hover {
            background: #161b22;
        }
        .project-section-header .project-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        .project-section-header .project-name {
            font-weight: 600;
            color: #f0f6fc;
        }
        .project-section-header .project-count {
            color: #8b949e;
            font-size: 12px;
            margin-left: auto;
        }
        .project-items {
            padding-left: 12px;
        }
        .project-items.collapsed {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Interactive Commit & PR Sentiment Explorer</h1>
    <p>Click project buttons to filter. Circles = commits, Diamonds = PRs. Hover for details.</p>

    <div class="controls">
        <div class="control-group">
            <span class="control-label">Projects:</span>
            <div class="project-filters" id="project-filters"></div>
        </div>
        <div class="control-group">
            <span class="control-label">Show:</span>
            <div class="type-filters">
                <button class="type-btn active" data-type="commits">Commits</button>
                <button class="type-btn active" data-type="prs">PRs</button>
            </div>
        </div>
        <div class="control-group">
            <button class="type-btn" id="select-all">Select All</button>
            <button class="type-btn" id="select-none">Clear All</button>
        </div>
    </div>

    <div class="chart-container">
        <div class="stats-bar" id="stats-bar">
            <div class="stat">
                <div class="stat-value" id="total-items">0</div>
                <div class="stat-label">Total Items</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="commits-count">0</div>
                <div class="stat-label">Commits</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="prs-count">0</div>
                <div class="stat-label">PRs</div>
            </div>
            <div class="stat">
                <div class="stat-value positive" id="positive-count">0</div>
                <div class="stat-label">Positive</div>
            </div>
            <div class="stat">
                <div class="stat-value negative" id="negative-count">0</div>
                <div class="stat-label">Negative</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="avg-sentiment">0</div>
                <div class="stat-label">Avg Sentiment</div>
            </div>
        </div>
        <div id="main-chart"></div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-shape"><svg width="12" height="12"><circle cx="6" cy="6" r="5" fill="#388bfd"/></svg></div>
                <span>Commit</span>
            </div>
            <div class="legend-item">
                <div class="legend-shape"><svg width="14" height="14"><polygon points="7,1 13,7 7,13 1,7" fill="#a855f7"/></svg></div>
                <span>Pull Request</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #22c55e"></div>
                <span>Positive</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444"></div>
                <span>Negative</span>
            </div>
        </div>
        <div class="hover-preview empty" id="hover-preview">
            Hover over a chart point to see details. Click to scroll to the item below.
        </div>
    </div>

    <div class="detail-panel" id="detail-panel">
        <h3 id="detail-title">Commits & Pull Requests</h3>
        <p style="color: #8b949e; font-size: 12px; margin: 0 0 15px 0;">
            Click on chart points to scroll to items. Click project headers to collapse/expand.
        </p>
        <div class="detail-list" id="detail-list"></div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <div id="loading" style="text-align: center; padding: 40px; color: #8b949e;">
        Loading data...
    </div>

    <script>
        // ============ DATA (loaded from JSON) ============
        let projects, colors, allData, startDate, endDate, meta;
        const parseDate = d3.timeParse("%Y-%m-%d");

        async function loadData() {
            try {
                const [commitsRes, metaRes] = await Promise.all([
                    fetch('data/commits.json'),
                    fetch('data/meta.json')
                ]);
                const commits = await commitsRes.json();
                meta = await metaRes.json();
                projects = meta.projects;
                colors = meta.colors;

                // URL params for custom date range
                const urlParams = new URLSearchParams(window.location.search);
                startDate = parseDate(urlParams.get('start') || meta.dateRange.start);
                endDate = parseDate(urlParams.get('end') || meta.dateRange.end);

                // Process commits with sentiment
                allData = commits.map(d => ({
                    ...d,
                    dateObj: parseDate(d.date),
                    sentiment: calculateSentiment(d.msg)
                }));

                document.getElementById('loading').style.display = 'none';
                return true;
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('loading').innerHTML = 'Failed to load data. <a href="#" onclick="location.reload()">Retry</a>';
                return false;
            }
        }

        // Developer-specific sentiment lexicon
        const sentimentLexicon = {
            "complete": 4, "milestone": 4, "breakthrough": 5, "works": 3,
            "implement": 3, "feature": 3, "enhance": 3, "improve": 3, "add": 2,
            "success": 4, "release": 3, "ready": 2, "validated": 3, "production": 2,
            "refactor": 1, "clean": 2, "optimize": 2, "update": 1, "merge": 1,
            "support": 2, "integration": 1, "comprehensive": 2, "major": 2,
            "fix": -1, "bug": -2, "error": -2, "crash": -3, "broken": -3,
            "issue": -1, "stuck": -2, "frozen": -2, "fail": -2, "missing": -1,
            "critical": -4, "urgent": -3, "severe": -4, "fatal": -5,
            "regression": -3, "blocker": -4, "hack": -2, "workaround": -1,
            "typescript": 2, "foundation": 2, "infrastructure": 2, "enhanced": 2
        };

        function calculateSentiment(msg) {
            const words = msg.toLowerCase().split(/[\s\-_:,.()\[\]]+/);
            let score = 0;
            words.forEach(word => {
                if (sentimentLexicon[word]) score += sentimentLexicon[word];
            });
            if (msg.includes("ðŸŽ‰") || msg.includes("âœ…") || msg.includes("ðŸ¹") || msg.includes("ðŸ†")) score += 3;
            return score;
        }

        // Get matched keywords with their scores
        function getMatchedKeywords(msg) {
            const words = msg.toLowerCase().split(/[\s\-_:,.()\[\]]+/);
            const matches = [];
            const seen = new Set();
            words.forEach(word => {
                if (sentimentLexicon[word] && !seen.has(word)) {
                    seen.add(word);
                    matches.push({ word, score: sentimentLexicon[word] });
                }
            });
            // Check for emojis
            if (msg.includes("ðŸŽ‰")) matches.push({ word: "ðŸŽ‰", score: 3 });
            if (msg.includes("âœ…")) matches.push({ word: "âœ…", score: 3 });
            if (msg.includes("ðŸ¹")) matches.push({ word: "ðŸ¹", score: 3 });
            if (msg.includes("ðŸ†")) matches.push({ word: "ðŸ†", score: 3 });
            return matches;
        }

        // Generate unique ID for each data item
        function getItemId(d) {
            return `item-${hashCode(d.date + d.project + d.msg)}`;
        }

        // Main initialization
        async function init() {
            if (!await loadData()) return;

        // ============ STATE ============
        let activeProjects = new Set(projects);
        let showCommits = true;
        let showPRs = true;

        // ============ UI SETUP ============
        const tooltip = d3.select("#tooltip");

        // Create project filter buttons
        const filterContainer = d3.select("#project-filters");
        projects.forEach(p => {
            filterContainer.append("button")
                .attr("class", "project-btn active")
                .attr("data-project", p)
                .style("border-color", colors[p])
                .style("background-color", colors[p])
                .text(p)
                .on("click", function() {
                    toggleProject(p);
                });
        });

        // Type filter buttons
        d3.selectAll(".type-filters .type-btn").on("click", function() {
            const type = d3.select(this).attr("data-type");
            if (type === "commits") {
                showCommits = !showCommits;
                d3.select(this).classed("active", showCommits);
            } else if (type === "prs") {
                showPRs = !showPRs;
                d3.select(this).classed("active", showPRs);
            }
            updateChart();
        });

        // Select all / none
        d3.select("#select-all").on("click", () => {
            activeProjects = new Set(projects);
            updateProjectButtons();
            updateChart();
        });
        d3.select("#select-none").on("click", () => {
            activeProjects.clear();
            updateProjectButtons();
            updateChart();
        });

        function toggleProject(p) {
            if (activeProjects.has(p)) {
                activeProjects.delete(p);
            } else {
                activeProjects.add(p);
            }
            updateProjectButtons();
            updateChart();
        }

        function updateProjectButtons() {
            d3.selectAll(".project-btn").each(function() {
                const btn = d3.select(this);
                const p = btn.attr("data-project");
                const isActive = activeProjects.has(p);
                btn.classed("active", isActive)
                   .classed("inactive", !isActive)
                   .style("background-color", isActive ? colors[p] : "transparent");
            });
        }

        // ============ CHART ============
        const width = 1340, height = 500;
        const margin = {top: 40, right: 30, bottom: 50, left: 60};

        const svg = d3.select("#main-chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // Background regions
        const chartArea = svg.append("g").attr("class", "chart-area");

        // Scales (fixed to full date range)
        const x = d3.scaleTime()
            .domain([startDate, endDate])
            .range([margin.left, width - margin.right]);

        const maxAbs = d3.max(allData, d => Math.abs(d.sentiment)) || 5;
        const y = d3.scaleLinear()
            .domain([-maxAbs - 1, maxAbs + 1])
            .range([height - margin.bottom, margin.top]);

        // Draw static elements
        // Positive background
        chartArea.append("rect")
            .attr("x", margin.left)
            .attr("y", margin.top)
            .attr("width", width - margin.left - margin.right)
            .attr("height", y(0) - margin.top)
            .attr("fill", "#22c55e")
            .attr("opacity", 0.03);

        // Negative background
        chartArea.append("rect")
            .attr("x", margin.left)
            .attr("y", y(0))
            .attr("width", width - margin.left - margin.right)
            .attr("height", height - margin.bottom - y(0))
            .attr("fill", "#ef4444")
            .attr("opacity", 0.03);

        // Zero line
        chartArea.append("line")
            .attr("x1", margin.left)
            .attr("x2", width - margin.right)
            .attr("y1", y(0))
            .attr("y2", y(0))
            .attr("stroke", "#30363d")
            .attr("stroke-width", 2);

        // Labels
        chartArea.append("text")
            .attr("x", margin.left + 10)
            .attr("y", margin.top + 15)
            .attr("fill", "#22c55e")
            .attr("font-size", "11px")
            .text("âœ“ Features, Improvements, Milestones");

        chartArea.append("text")
            .attr("x", margin.left + 10)
            .attr("y", height - margin.bottom - 8)
            .attr("fill", "#ef4444")
            .attr("font-size", "11px")
            .text("âœ— Bugs, Crashes, Critical Fixes");

        // X axis
        svg.append("g")
            .attr("class", "axis x-axis")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x).ticks(d3.timeWeek.every(1)).tickFormat(d3.timeFormat("%b %d")));

        // Y axis
        svg.append("g")
            .attr("class", "axis y-axis")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y).ticks(7));

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", -height/2)
            .attr("y", 15)
            .attr("fill", "#8b949e")
            .attr("text-anchor", "middle")
            .attr("font-size", "11px")
            .text("Sentiment Score");

        // Data layer
        const dataLayer = svg.append("g").attr("class", "data-layer");

        function updateChart() {
            // Filter data
            const filteredData = allData.filter(d => {
                if (!activeProjects.has(d.project)) return false;
                if (d.type === "commit" && !showCommits) return false;
                if (d.type === "pr" && !showPRs) return false;
                return true;
            });

            // Update stats
            const commits = filteredData.filter(d => d.type === "commit");
            const prs = filteredData.filter(d => d.type === "pr");
            const positive = filteredData.filter(d => d.sentiment > 0);
            const negative = filteredData.filter(d => d.sentiment < 0);
            const avgSentiment = filteredData.length > 0
                ? (d3.sum(filteredData, d => d.sentiment) / filteredData.length).toFixed(1)
                : 0;

            d3.select("#total-items").text(filteredData.length);
            d3.select("#commits-count").text(commits.length);
            d3.select("#prs-count").text(prs.length);
            d3.select("#positive-count").text(positive.length);
            d3.select("#negative-count").text(negative.length);
            d3.select("#avg-sentiment").text(avgSentiment);

            // Draw stems
            const stems = dataLayer.selectAll(".stem")
                .data(filteredData, d => d.date + d.project + d.msg);

            stems.exit().remove();

            stems.enter()
                .append("line")
                .attr("class", "stem")
                .merge(stems)
                .attr("x1", d => x(d.dateObj) + (hashCode(d.msg) % 20 - 10))
                .attr("x2", d => x(d.dateObj) + (hashCode(d.msg) % 20 - 10))
                .attr("y1", y(0))
                .attr("y2", d => y(d.sentiment))
                .attr("stroke", d => d.sentiment >= 0 ? "#22c55e" : "#ef4444")
                .attr("stroke-width", 1.5)
                .attr("opacity", 0.4);

            // Draw points
            const points = dataLayer.selectAll(".point")
                .data(filteredData, d => d.date + d.project + d.msg);

            points.exit().remove();

            const pointsEnter = points.enter()
                .append("g")
                .attr("class", "point");

            // Commits = circles
            pointsEnter.filter(d => d.type === "commit")
                .append("circle")
                .attr("r", 6);

            // PRs = diamonds
            pointsEnter.filter(d => d.type === "pr")
                .append("polygon")
                .attr("points", "0,-8 8,0 0,8 -8,0");

            const allPoints = pointsEnter.merge(points);

            allPoints
                .attr("transform", d => {
                    const cx = x(d.dateObj) + (hashCode(d.msg) % 20 - 10);
                    const cy = y(d.sentiment);
                    return `translate(${cx},${cy})`;
                });

            allPoints.select("circle")
                .attr("fill", d => colors[d.project])
                .attr("stroke", d => d.sentiment >= 0 ? "#22c55e" : "#ef4444")
                .attr("stroke-width", 2);

            allPoints.select("polygon")
                .attr("fill", d => colors[d.project])
                .attr("stroke", d => d.sentiment >= 0 ? "#22c55e" : "#ef4444")
                .attr("stroke-width", 2);

            allPoints
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    // Update fixed hover preview
                    updateHoverPreview(d);
                    // Highlight corresponding list item (no scroll)
                    highlightListItem(d, true, false);
                })
                .on("mouseout", function(event, d) {
                    // Clear hover preview
                    clearHoverPreview();
                    // Remove highlight from list item
                    highlightListItem(d, false, false);
                })
                .on("click", function(event, d) {
                    // Scroll to item on click
                    scrollToListItem(d);
                });

            // Update the detail list below the chart
            updateDetailList(filteredData);
        }

        // Simple hash for consistent jitter
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        // Track collapsed projects
        const collapsedProjects = new Set();

        // Render detail list below chart
        function updateDetailList(filteredData) {
            const detailList = d3.select("#detail-list");
            detailList.html("");

            // Group by project
            const byProject = d3.group(filteredData, d => d.project);

            // Sort projects by their order in the projects array
            const sortedProjects = projects.filter(p => byProject.has(p));

            sortedProjects.forEach(project => {
                const items = byProject.get(project);
                // Sort by date descending
                items.sort((a, b) => new Date(b.date) - new Date(a.date));

                const section = detailList.append("div")
                    .attr("class", "project-section")
                    .attr("data-project", project);

                const header = section.append("div")
                    .attr("class", "project-section-header")
                    .on("click", function() {
                        if (collapsedProjects.has(project)) {
                            collapsedProjects.delete(project);
                        } else {
                            collapsedProjects.add(project);
                        }
                        itemsContainer.classed("collapsed", collapsedProjects.has(project));
                    });

                header.append("div")
                    .attr("class", "project-color")
                    .style("background-color", colors[project]);

                header.append("span")
                    .attr("class", "project-name")
                    .text(project);

                const commitCount = items.filter(d => d.type === "commit").length;
                const prCount = items.filter(d => d.type === "pr").length;
                header.append("span")
                    .attr("class", "project-count")
                    .text(`${commitCount} commits, ${prCount} PRs`);

                const itemsContainer = section.append("div")
                    .attr("class", "project-items")
                    .classed("collapsed", collapsedProjects.has(project));

                items.forEach(d => {
                    const itemId = getItemId(d);
                    const keywords = getMatchedKeywords(d.msg);
                    const sentimentClass = d.sentiment > 0 ? "positive" : (d.sentiment < 0 ? "negative" : "neutral");

                    const item = itemsContainer.append("div")
                        .attr("class", "detail-item")
                        .attr("id", itemId)
                        .attr("data-item-id", itemId)
                        .on("mouseenter", function() {
                            highlightChartPoint(d, true);
                        })
                        .on("mouseleave", function() {
                            highlightChartPoint(d, false);
                        });

                    // Header row
                    const itemHeader = item.append("div")
                        .attr("class", "item-header");

                    itemHeader.append("span")
                        .attr("class", `type-badge ${d.type}`)
                        .text(d.type);

                    itemHeader.append("span")
                        .attr("class", "project-badge")
                        .style("background-color", colors[d.project])
                        .text(d.project);

                    itemHeader.append("span")
                        .attr("class", "date")
                        .text(d.date);

                    // Message
                    item.append("div")
                        .attr("class", "msg")
                        .text(d.msg);

                    // Sentiment info row
                    const sentimentInfo = item.append("div")
                        .attr("class", "sentiment-info");

                    sentimentInfo.append("span")
                        .attr("class", `sentiment-score ${sentimentClass}`)
                        .text(`Score: ${d.sentiment > 0 ? '+' : ''}${d.sentiment}`);

                    if (keywords.length > 0) {
                        const keywordsContainer = sentimentInfo.append("div")
                            .attr("class", "keywords");

                        keywords.forEach(k => {
                            const keywordClass = k.score > 0 ? "positive" : "negative";
                            keywordsContainer.append("span")
                                .attr("class", `keyword ${keywordClass}`)
                                .text(`${k.word} (${k.score > 0 ? '+' : ''}${k.score})`);
                        });
                    } else {
                        sentimentInfo.append("span")
                            .style("color", "#8b949e")
                            .style("font-size", "11px")
                            .text("No keyword matches");
                    }
                });
            });
        }

        // Update hover preview panel
        function updateHoverPreview(d) {
            const preview = d3.select("#hover-preview");
            const keywords = getMatchedKeywords(d.msg);
            const sentimentClass = d.sentiment > 0 ? "positive" : (d.sentiment < 0 ? "negative" : "neutral");

            preview.classed("empty", false);
            preview.html(`
                <div class="preview-header">
                    <span class="preview-type ${d.type}">${d.type}</span>
                    <span class="preview-project" style="background-color: ${colors[d.project]}">${d.project}</span>
                    <span class="preview-date">${d.date}</span>
                </div>
                <div class="preview-msg">${d.msg}</div>
                <div class="preview-sentiment">
                    <span class="preview-score ${sentimentClass}">Score: ${d.sentiment > 0 ? '+' : ''}${d.sentiment}</span>
                    ${keywords.length > 0 ? keywords.map(k => `<span style="color: ${k.score > 0 ? '#22c55e' : '#ef4444'}; font-size: 11px;">${k.word} (${k.score > 0 ? '+' : ''}${k.score})</span>`).join(' ') : '<span style="color: #484f58; font-size: 11px;">No keyword matches</span>'}
                    <span class="preview-hint">Click to scroll to item</span>
                </div>
            `);
        }

        // Clear hover preview
        function clearHoverPreview() {
            const preview = d3.select("#hover-preview");
            preview.classed("empty", true);
            preview.html("Hover over a chart point to see details. Click to scroll to the item below.");
        }

        // Scroll to list item
        function scrollToListItem(d) {
            const itemId = getItemId(d);
            const element = document.getElementById(itemId);
            if (element) {
                element.scrollIntoView({ behavior: "smooth", block: "center" });
                // Flash highlight
                d3.select(`#${itemId}`).classed("highlighted", true);
                setTimeout(() => {
                    d3.select(`#${itemId}`).classed("highlighted", false);
                }, 2000);
            }
        }

        // Highlight a chart point
        function highlightChartPoint(d, highlight) {
            dataLayer.selectAll(".point")
                .filter(pd => pd.date === d.date && pd.project === d.project && pd.msg === d.msg)
                .select("circle, polygon")
                .attr("stroke-width", highlight ? 4 : 2)
                .attr("stroke", highlight ? "#f0f6fc" : (pd => pd.sentiment >= 0 ? "#22c55e" : "#ef4444"));
        }

        // Highlight a list item (optional scroll)
        function highlightListItem(d, highlight, shouldScroll = false) {
            const itemId = getItemId(d);
            const item = d3.select(`#${itemId}`);
            item.classed("highlighted", highlight);

            if (highlight && shouldScroll) {
                const element = document.getElementById(itemId);
                if (element) {
                    element.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }
        }

        // Initial render
        updateChart();
        }

        // Start the application
        init();
    </script>
</body>
</html>
